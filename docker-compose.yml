version: '3.8'

services:
  # PostgreSQL Database - Port 4904
  atria_postgres:
    image: postgres:15-alpine
    container_name: atria_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: atria_admin
      POSTGRES_PASSWORD: atria_secure_2024
      POSTGRES_DB: atria360
    ports:
      - "4904:5432"
    volumes:
      - atria_postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U atria_admin -d atria360"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - atria_network

  # pgAdmin - Port 4905
  atria_pgadmin:
    image: dpage/pgadmin4:latest
    container_name: atria_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@atria360.com
      PGADMIN_DEFAULT_PASSWORD: admin@4905
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "4905:80"
    volumes:
      - atria_pgadmin_data:/var/lib/pgadmin
    depends_on:
      - atria_postgres
    networks:
      - atria_network

  # Redis (for queues and caching) - Port 4906
  atria_redis:
    image: redis:7-alpine
    container_name: atria_redis
    restart: unless-stopped
    ports:
      - "4906:6379"
    volumes:
      - atria_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - atria_network

  # Mailhog (DEV email testing) - Port 4908
  atria_mailhog:
    image: mailhog/mailhog:latest
    container_name: atria_mailhog
    restart: unless-stopped
    ports:
      - "4908:8025"  # Web UI
      - "1025:1025"   # SMTP
    networks:
      - atria_network

  # Backend API (Express) - Port 4902
  atria_api:
    build:
      context: ./Strenght-360/backend
      dockerfile: Dockerfile
    container_name: atria_api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4902
      DATABASE_URL: postgresql://atria_admin:atria_secure_2024@atria_postgres:5432/atria360
      REDIS_URL: redis://atria_redis:6379
      SMTP_HOST: atria_mailhog
      SMTP_PORT: 1025
      SMTP_USER: ""
      SMTP_PASS: ""
      SMTP_FROM: "noreply@atria360.com"
      JWT_SECRET: "change_this_in_production_use_env_variable"
      CORS_ORIGINS: "http://localhost:4901,http://localhost:4903"
    ports:
      - "4902:4902"
    volumes:
      - ./Strenght-360/backend:/app
      - /app/node_modules
      - ./reports:/app/reports
    depends_on:
      atria_postgres:
        condition: service_healthy
      atria_redis:
        condition: service_healthy
    networks:
      - atria_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4902/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Candidate Frontend (React) - Port 4901
  atria_frontend:
    build:
      context: ./Strenght-360
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_URL: http://localhost:4902/api
    container_name: atria_frontend
    restart: unless-stopped
    environment:
      VITE_API_URL: http://localhost:4902/api
    ports:
      - "4901:80"
    depends_on:
      - atria_api
    networks:
      - atria_network

  # Admin Portal (React) - Port 4903
  atria_admin:
    build:
      context: ./Beyonders-360-main
      dockerfile: Dockerfile.admin
      args:
        VITE_API_URL: http://localhost:4902
    container_name: atria_admin
    restart: unless-stopped
    environment:
      VITE_API_URL: http://localhost:4902
    ports:
      - "4903:80"
    depends_on:
      - atria_api
    networks:
      - atria_network

  # Worker (Email + Async Jobs) - Port 4907
  atria_worker:
    build:
      context: ./Strenght-360/backend
      dockerfile: Dockerfile.worker
    container_name: atria_worker
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://atria_admin:atria_secure_2024@atria_postgres:5432/atria360
      REDIS_URL: redis://atria_redis:6379
      SMTP_HOST: atria_mailhog
      SMTP_PORT: 1025
      SMTP_USER: ""
      SMTP_PASS: ""
      SMTP_FROM: "noreply@atria360.com"
    volumes:
      - ./Strenght-360/backend:/app
      - /app/node_modules
    depends_on:
      atria_postgres:
        condition: service_healthy
      atria_redis:
        condition: service_healthy
    networks:
      - atria_network

networks:
  atria_network:
    driver: bridge

volumes:
  atria_postgres_data:
  atria_pgadmin_data:
  atria_redis_data:
